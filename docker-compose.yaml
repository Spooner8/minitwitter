version: '3.8'

name: minitwitter
services:
    loadbalancer:
        image: nginx
        container_name: loadbalancer
        volumes:
            - ./nginx.conf:/etc/nginx/nginx.conf:ro
        ports:
            - '80:80'
        restart: always
        networks:
            - minitwitter
    db:
        container_name: db
        image: postgres
        ports:
            - '5432:5432'
        environment:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: supersecret123
            POSTGRES_DB: minitwitter
        volumes:
            - minitwitter-db:/var/lib/postgresql/data
        networks:
            - minitwitter
        restart: always

    api-1:
        container_name: api-1
        image: spoonersl/minitwitter
        environment:
            DATABASE_URL: postgressql://postgres:supersecret123@db:5432/minitwitter
            OLLAMA_BASE_URL: http://ollama
        depends_on:
            - db
        command: /bin/sh -c "bunx drizzle-kit push && bun run prod"
        networks:
            - minitwitter
        restart: always

    api-2:
        container_name: api-2
        image: spoonersl/minitwitter
        environment:
            DATABASE_URL: postgressql://postgres:supersecret123@db:5432/minitwitter
            OLLAMA_BASE_URL: http://ollama
        depends_on:
            - db
        command: /bin/sh -c "bunx drizzle-kit push && bun run prod"
        networks:
            - minitwitter
        restart: always

    ollama-1:
        container_name: ollama-1
        image: ollama/ollama
        ports:
            - '11434:11434'            
        volumes:
            - minitwitter-ollama:/root/.ollama
        networks:
            - minitwitter
        restart: always

volumes:
    minitwitter-db:
    minitwitter-ollama:

networks:
    minitwitter:
        driver: bridge